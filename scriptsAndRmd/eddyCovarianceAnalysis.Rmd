---
title: "eddyCovarianceAnalysis"
author: "Sarah Waldo"
date: "November 28, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# LIBRARIES---------------
library(readxl)  # For reading Excel files
library(gdata)   # Also for reading Excel files
library(ggplot2) # For plotting
library(gridExtra) # For plotting
library(scales)  # For plotting
library(rgl) # For plotting interactive response surface in 3d
#library(persp3D) # Not compable with R 3.3.0
library(scatterplot3d)  # for plotting
library(reshape) # For merge_recurse function
library(reshape2) # For melt/dcast
library(tidyr)  # for separate

library(knitr)   # To knit rmarkdown document
library(ggmap)   # For ggmap plot of reservoirs
library(rgdal)   # For reading shapefiles
library(spsurvey)  # survey design
library(maptools) # for ggplot plotting of shapefile (fortify function)
#library(minpack.lm) # for non linear diffusion model -- not available for v3.4

library(plot3D)
library(plot3Drgl)   

library(openair)
library(FREddyPro)
library(EBImage)

# car for variance inflation factor (vif)
# http://www.statmethods.net/stats/rdiagnostics.html)
library(car) # vif function
library(fmsb) # variance inflation factor 'VIF' function
library(relaimpo)  # dependent on MASS, which masks dplyr select
library(nlme) # for gls function
library(piecewiseSEM) # for rsquared of lme model

# Always load dplyr after plyr and relaimpo!  These packages mask
# dplyr functions.
library(plyr)  # for 'join' in ggplot plotting of shapefile
library(dplyr)   # For data manipulation
library(tidyr)
library(lubridate)

 library(ggplot2) # load from masterLibrary
 library(scales)  # load from masterLibrary
library(stringr)
source("C:/R_Projects/actonFluxProject/scriptsAndRmd/calc_footprint_FFP_climatology.R")

```

## Load Eddy Pro Output

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
myWd<-  "L:/Priv/Cin/NRMRL/ReservoirEbullitionStudy/actonEddyCovariance"

#######LOAD IN EDDYPRO OUTPUT------
epFiles <- list.files(paste(myWd, "/L1eddyproOut/fullOutput2017", sep=""),
                      pattern="*.csv$", recursive = FALSE) 
epFiles
epList <- list()  # Empty list to hold results

##header   
epHeader<- c("filename",	"date",	"time",	"DOY",	"daytime",	"file_records",	"used_records",
"Tau",	"qc_Tau",	"rand_err_Tau",	"H",	"qc_H",	"rand_err_H",	"LE",	"qc_LE",	"rand_err_LE",
"co2_flux",	"qc_co2_flux",	"rand_err_co2_flux",	"h2o_flux",	"qc_h2o_flux",	
"rand_err_h2o_flux",	"ch4_flux",	"qc_ch4_flux",	"rand_err_ch4_flux",	"H_strg",	"LE_strg",
"co2_strg",	"h2o_strg",	"ch4_strg",	"co2_vadv",	"h2o_vadv",	"ch4_vadv",	
"co2_molar_density",	"co2_mole_fraction",	"co2_mixing_ratio",	"co2_time_lag",
"co2_def_timelag",	"h2o_molar_density",	"h2o_mole_fraction",	"h2o_mixing_ratio",
"h2o_time_lag",	"h2o_def_timelag",	"ch4_molar_density",	"ch4_mole_fraction",
"ch4_mixing_ratio",	"ch4_time_lag",	"ch4_def_timelag",	"sonic_temperature",
"air_temperature",	"air_pressure",	"air_density",	"air_heat_capacity",	"air_molar_volume",
"ET",	"water_vapor_density",	"e",	"es",	"specific_humidity",	"RH",	"VPD",	"Tdew",
"u_unrot",	"v_unrot",	"w_unrot",	"u_rot",	"v_rot",	"w_rot",	"wind_speed",
"max_wind_speed",	"wind_dir",	"yaw",	"pitch",	"roll",	"ustar",	"TKE",	"L",	"zL",	
"bowen_ratio",	"Tstar",	"model",	"x_peak",	"x_offset",	"x_10",	"x_30",	"x_50",	"x_70",
"x_90",	"un_Tau",	"Tau_scf",	"un_H",	"H_scf",	"un_LE",	"LE_scf",	"un_co2_flux",	"co2_scf",
"un_h2o_flux",	"h2o_scf",	"un_ch4_flux",	"ch4_scf",	"spikes_hf",	"amplitude_resolution_hf",
"drop_out_hf",	"absolute_limits_hf",	"skewness_kurtosis_hf",	"skewness_kurtosis_sf",
"discontinuities_hf",	"discontinuities_sf",	"timelag_hf",	"timelag_sf",	"attack_angle_hf",
"non_steady_wind_hf",	"u_spikes",	"v_spikes",	"w_spikes",	"ts_spikes",	"co2_spikes",
"h2o_spikes",	"ch4_spikes",	"chopper_LI7500",	"detector_LI7500",	"pll_LI7500",	"sync_LI7500",
"not_ready_LI7700",	"no_signal_LI7700",	"re_unlocked_LI7700",	"bad_temp_LI7700",	
"laser_temp_unregulated_LI7700",	"block_temp_unregulated_LI7700",	"motor_spinning_LI7700",
"pump_on_LI7700",	"top_heater_on_LI7700",	"bottom_heater_on_LI7700",	"calibrating_LI7700",
"motor_failure_LI7700",	"bad_aux_tc1_LI7700",	"bad_aux_tc2_LI7700",	"bad_aux_tc3_LI7700",
'box_connected_LI7700',	"mean_value_RSSI_LI7500",	"u_var",	"v_var",	"w_var",	"ts_var",
"co2_var",	"h2o_var",	"ch4_var",	"wts_cov",	"wco2_cov",	"wh2o_cov",	"wch4_cov",
"air_t_mean",	"air_p_mean",	"co2_mean",	"h2o_mean",	"dew_point_mean",	"co2_signal_strength_7500_mean",
"ch4_mean",	"rssi_77_mean",	"ch4_tc_1_mean",	"ch4_tc_2_mean",	"ch4_tc_3_mean")
  
#back to reality

for (i in 1:length(epFiles)) {  # loop to read and format each file
    ep.i <- read.table(paste(myWd, "/L1eddyproOut/fullOutput2017/", 
                                    epFiles[i], sep=""),
                              sep=",",  # comma separate
                              skip=3,  # Skip first line of file.  Header info
                              colClasses = c(rep("character", 3), rep("numeric", 97), rep("character",12), rep("numeric", 50)),
                              as.is=TRUE, # Prevent conversion to factor
                              header=FALSE, # don't import column names
                              col.names = epHeader,
                              na.strings = "NaN",
                              fill=TRUE)  # Needed to deal with empty cells in last column
  #format date and time
    ep.i$RDateTime <- as.POSIXct(paste(ep.i$date, ep.i$time,sep=""),
                                  format="%m/%d/%Y%H:%M",
                                  tz = "UTC")  # POSIXct
 #select what we want: wind direction, ch4 flux, time of day, stability parameters, footprint, 
    ep.i <- select(ep.i, -filename, -co2_time_lag, -co2_def_timelag, -h2o_time_lag, -h2o_def_timelag, -ch4_time_lag, -ch4_def_timelag, -un_Tau, -Tau_scf, -un_H, -H_scf, -un_LE, -LE_scf, -un_co2_flux, -un_h2o_flux, -h2o_scf, -un_ch4_flux, -ch4_scf)  # select minimal columns of interest
      #select(ep.i, RDateTime, ch4_flux, wind_speed, wind_dir, ustar, TKE, L, zL, x_70, w_var)  # select columns of interest
    
    epList[[i]] <- ep.i  # dump in list
}  # End of loop, < 1 minute

epOut <- do.call("rbind", epList)  # Coerces list into dataframe.
str(epOut$RDateTime)
````


#Plot eddypro out
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
####PLOT########
# summary(epOut$RDateTime)
#  
# ggplot(epOut, aes(RDateTime, ch4_flux))+
#   geom_point(alpha=0.1)
# 
# ggplot(epOut, aes(RDateTime, zL))+
#   geom_point(alpha=0.1)
# 
# epOut$date<-epOut$RDateTime
# epOutFilt<-filter(epOut, abs(zL)<25)
# 
# ggplot(epOutFilt, aes(RDateTime, zL))+
#   geom_point(alpha=0.1)
# 
# zLDiurnalPlot<-timeVariation(epOutFilt, pollutant="zL", type="month")
# plot(zLDiurnalPlot, subset="hour")
# 
# UdiurnalPlot<-timeVariation(epOutFilt, pollutant="wind_speed", type = "month")
# plot(UdiurnalPlot, subset="hour")

```

###Read in 5-min results
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
epFiles5 <- list.files(paste(myWd, "/L1eddyproOut/fullOutput2017/5min", sep=""),
                      pattern="*.csv$", recursive = TRUE) 
epFiles5
epList5 <- list()  # Empty list to hold results

for (i in 1:length(epFiles5)) {  # loop to read and format each file
    ep5.i <- read.table(paste(myWd, "/L1eddyproOut/fullOutput2017/5min/", 
                                    epFiles5[i], sep=""),
                              sep=",",  # comma separate
                              skip=3,  # Skip first line of file.  Header info
                              colClasses = c(rep("character", 3), rep("numeric", 97), rep("character",12), rep("numeric", 50)),
                              as.is=TRUE, # Prevent conversion to factor
                              header=FALSE, # don't import column names
                              col.names = epHeader,
                              na.strings = "NaN",
                              fill=TRUE)  # Needed to deal with empty cells in last column
  #format date and time
    ep5.i$RDateTime <- as.POSIXct(paste(ep5.i$date, ep5.i$time,sep=""),
                                  format="%Y-%m-%d%H:%M",
                                  tz = "UTC")  # POSIXct
 #select what we want: wind direction, ch4 flux, time of day, stability parameters, footprint, 
    ep5.i <- select(ep5.i, -filename, -co2_time_lag, -co2_def_timelag, -h2o_time_lag, -h2o_def_timelag, -ch4_time_lag, -ch4_def_timelag, -un_Tau, -Tau_scf, -un_H, -H_scf, -un_LE, -LE_scf, -un_co2_flux, -un_h2o_flux, -h2o_scf, -un_ch4_flux, -ch4_scf)  # select minimal columns of interest
      #select(ep.i, RDateTime, ch4_flux, wind_speed, wind_dir, ustar, TKE, L, zL, x_70, w_var)  # select columns of interest
    
    epList5[[i]] <- ep5.i  # dump in list
}  # End of loop, < 1 minute

epOut5 <- do.call("rbind", epList5)  # Coerces list into dataframe.

```



###Read in vanni weather station data
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

vws<-read.csv(paste(myWd, "/vanniWeatherStation/vws20160929_20171106_concat.csv", sep=""),
           sep=",",
           skip=5,
           #colClasses=c("character", rep("numeric", 10)),
           as.is=TRUE,
           header=FALSE,
           col.names=c("dateTime","PAR","WindDir","WindSp","AirTemp","RH","BP","DailyRain","Level","Temp","Bat"),
           na.strings="NaN",
           fill=TRUE)

vws$RH<-as.numeric(vws$RH)
vws$BP<-as.numeric(vws$BP)
vws$WindDir<-as.numeric(vws$WindDir)
vws$WindSp<-as.numeric(vws$WindSp)
vws$AirTemp<-as.numeric(vws$AirTemp)
vws$DailyRain<-as.numeric(vws$DailyRain)

vws$RDateTime <- as.POSIXct(vws$dateTime,
                                  format="%m/%d/%Y%H:%M",
                                  tz = "UTC")  # POSIXct

ggplot(vws, aes(RDateTime, Level))+
  geom_line()+
  ylim(0, 1)

library(plotly)

plot_ly(data=vws, x=~RDateTime, y=~Level, type="scatter", mode="line")

#this plot shows thon April 25, 2017 between the data points of 10:45 and 11:15, the Level went from 0.472 to 0.317
#can fix this offset by adding 0.472-0.317 = 0.155 to all points after 4/25/17 11:15

vws$LevelAdj<-vws$Level

for(i in 1:nrow(vws)){
  if(vws$RDateTime[i]>"2017-04-25 10:45:00") {
    vws$LevelAdj[i]<-vws$LevelAdj[i]+0.155
  }
}

plot_ly(data=vws, x=~RDateTime, y=~LevelAdj, type="scatter", mode="line")

#The depth measured at site U-14 ranged from 1.2-1.6 m over the measurement season.
#We'll approximate the flux tower footprint water depth as Level + 1 m

vws$FFlevel<-vws$LevelAdj+1
vws$FFwaterPressure<-vws$FFlevel*9800   #pressure produced by 1-m of water is 9800 Pa
ggplot(vws, aes(RDateTime, FFwaterPressure))+
  geom_line()
#biggest deltaP from water is around 600 Pa

ggplot(epOut, aes(RDateTime, air_p_mean))+
  geom_line()

epOutVws<-left_join(epOut, vws, by="RDateTime")
ggplot(epOutVws, aes(RDateTime, FFwaterPressure))+
  geom_line()

epOutVws$hsPressure<-epOutVws$FFwaterPressure+epOutVws$air_p_mean
ggplot(epOutVws, aes(RDateTime, hsPressure))+
  geom_line()


epOutHSPDaily<-epOutVws%>%
  group_by(RDateTime=cut(RDateTime, breaks="1 day"))%>%
  summarize(meanHSP=mean(hsPressure))

epOutHSPDaily$RDateTime <- as.POSIXct(epOutHSPDaily$RDateTime,
                                  format="%Y-%m-%d",
                                  tz = "UTC")  # POSIXct

 ggplot(epOutHSPDaily, aes(RDateTime, meanHSP))+
  geom_line()  
 
 epOutAPDaily<-epOutVws%>%
  group_by(RDateTime=cut(RDateTime, breaks="1 day"))%>%
  summarize(meanAP=mean(air_p_mean))

epOutAPDaily$RDateTime <- as.POSIXct(epOutAPDaily$RDateTime,
                                  format="%Y-%m-%d",
                                  tz = "UTC")  # POSIXct

 ggplot(epOutAPDaily, aes(RDateTime, meanAP))+
  geom_line()               


#ranges up to 2000 Pa
```



###Output files to be used in the Kljun footprint calculator
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

epMonths <- c("June", "July", "Aug", "Sept", "Oct") #vector of months

for (i in 1:length(epMonths)) {
  epMonths.i <- epMonths[i]
    if(epMonths[i]=="June"){
      data.i<-filter(epOut, RDateTime>="2017-06-01"&RDateTime<"2017-07-01")
    }
    else if (epMonths[i]=="July"){
      data.i<-filter(epOut, RDateTime>="2017-07-01"&RDateTime<"2017-08-01")
    }
    else if (epMonths[i]=="Aug"){
      data.i<-filter(epOut, RDateTime>="2017-08-01"&RDateTime<"2017-09-01")
    }
    else if (epMonths[i]=="Sept"){
      data.i<-filter(epOut, RDateTime>="2017-09-01"&RDateTime<"2017-10-01")
    }
    else if (epMonths[i]=="Oct"){
      data.i<-filter(epOut, RDateTime>="2017-10-01"&RDateTime<"2017-11-01")
    }
  epOutKljun <-
  select(data.i, RDateTime, time, u_rot, L, ustar, wind_dir, v_var)
  epOutKljun$sigma_v <- sqrt(epOutKljun$v_var)
  epOutKljun$zm <- 2.85
  epOutKljun$z0 <- -999
  epOutKljun$d <- 0.0067
  epOutKljun$u_mean <- epOutKljun$u_rot
  
  #need to change time from local to UTC
  epOutKljun$RDateTimeUTC <- epOutKljun$RDateTime + (5 * 60 * 60)
  temp<-strsplit(as.character(epOutKljun$RDateTimeUTC), "-")
  tMat<-matrix(unlist(temp), ncol=3, byrow=TRUE)
  df_time<-as.data.frame(tMat)
  colnames(df_time)=(c("yyyy", "mm", "day"))
  
  temp<-strsplit(as.character(df_time$d), " ")
  tMat<-matrix(unlist(temp), ncol=2, byrow=TRUE)
  df_time2<-as.data.frame(tMat)
  colnames(df_time2)=c("day", "HHMMSS")
  
  temp<-strsplit(as.character(df_time2$HHMMSS), ":")
  tMat<-matrix(unlist(temp), ncol=3, byrow=TRUE)
  df_time3<-as.data.frame(tMat)
  colnames(df_time3)=c("HH", "MM", "SS")
  
  df_time<-select(df_time, -day)
  df_time2<-select(df_time2, -HHMMSS)
  df_time3<-select(df_time3, -SS)
  
  df_time$RDateTime<-epOutKljun$RDateTime
  df_time2$RDateTime<-epOutKljun$RDateTime
  df_time3$RDateTime<-epOutKljun$RDateTime
  
  epOutKljun<-left_join(epOutKljun, df_time, by="RDateTime")
  epOutKljun<-left_join(epOutKljun, df_time2, by="RDateTime")
  epOutKljun<-left_join(epOutKljun, df_time3, by="RDateTime")
  
  epOutKljunFilt <- filter(epOutKljun, L < -0.184 | L > 0)
  
  #filtered for L between -0.18387 and 0  (ie, z/L>-15.5)
  file.name = paste(
  "L:/Priv/Cin/NRMRL/ReservoirEbullitionStudy/actonEddyCovariance/footprint/",
  epMonths.i,
  "KljunFilt.csv",
  sep = ""
  )
  write.csv(
  select(epOutKljunFilt,
  yyyy, mm, day, HH, MM, zm, d, z0, u_mean, L, sigma_v, ustar, wind_dir),
  file = file.name,
  na = "-999",
  row.names = FALSE,
  quote = FALSE
  )
}

epOutJuneKljun<-select(epOutJune, RDateTime, time, u_rot, L, ustar, wind_dir, v_var )
epOutJuneKljun$sigma_v<-sqrt(epOutJuneKljun$v_var)
epOutJuneKljun$zm<-2.85
epOutJuneKljun$z0<- -999
epOutJuneKljun$d<-0.0067
epOutJuneKljun$u_mean<-epOutJuneKljun$u_rot

#need to change time from local to UTC
epOutJuneKljun$RDateTimeUTC<-epOutJuneKljun$RDateTime+(5*60*60)

temp<-strsplit(as.character(epOutJuneKljun$RDateTimeUTC), "-")
tMat<-matrix(unlist(temp), ncol=3, byrow=TRUE)
df_time<-as.data.frame(tMat)
colnames(df_time)=(c("yyyy", "mm", "day"))

temp<-strsplit(as.character(df_time$d), " ")
tMat<-matrix(unlist(temp), ncol=2, byrow=TRUE)
df_time2<-as.data.frame(tMat)
colnames(df_time2)=c("day", "HHMMSS")

temp<-strsplit(as.character(df_time2$HHMMSS), ":")
tMat<-matrix(unlist(temp), ncol=3, byrow=TRUE)
df_time3<-as.data.frame(tMat)
colnames(df_time3)=c("HH", "MM", "SS")

df_time<-select(df_time, -day)
df_time2<-select(df_time2, -HHMMSS)
df_time3<-select(df_time3, -SS)

df_time$RDateTime<-epOutJuneKljun$RDateTime
df_time2$RDateTime<-epOutJuneKljun$RDateTime
df_time3$RDateTime<-epOutJuneKljun$RDateTime

epOutJuneKljun<-left_join(epOutJuneKljun, df_time, by="RDateTime")
epOutJuneKljun<-left_join(epOutJuneKljun, df_time2, by="RDateTime")
epOutJuneKljun<-left_join(epOutJuneKljun, df_time3, by="RDateTime")

epOutJuneKljunUf<-filter(epOutJuneKljun, ustar>0.1)

write.csv(select(epOutJuneKljun, yyyy, mm, day, HH, MM, zm, d, z0, u_rot, L, sigma_v, ustar, wind_dir, blH), file="L:/Priv/Cin/NRMRL/ReservoirEbullitionStudy/actonEddyCovariance/footprint/JuneKljun.csv", na="-999", row.names=FALSE)

write.csv(select(epOutJuneKljunUf, yyyy, mm, day, HH, MM, zm, d, z0, u_rot, L, sigma_v, ustar, wind_dir), file="L:/Priv/Cin/NRMRL/ReservoirEbullitionStudy/actonEddyCovariance/footprint/JuneKljunUstarFilt.csv", na="-999", row.names=FALSE)

epOutJuneKljunFilt<-filter(epOutJuneKljun, ustar>0.1)
epOutJuneKljunFilt<-filter(epOutJuneKljunFilt, L>-0.184)

#filtered for both ustar>0.1 and L>-0.18387 (ie, z/L>-15.5)
write.csv(select(epOutJuneKljunFilt, yyyy, mm, day, HH, MM, zm, d, z0, u_mean, L, sigma_v, ustar, wind_dir), file="L:/Priv/Cin/NRMRL/ReservoirEbullitionStudy/actonEddyCovariance/footprint/JuneKljunFilt2.csv", 
          na="-999", 
          row.names=FALSE,
          quote=FALSE)

```


##The online Kljun footprint  calculator was not working for me, so I downloaded the R code 
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#this needs boundary layer heights as an input. Boundary layer height depends on stability. 

for(i in 1:nrow(epOutJuneKljun)){
  if((epOutJuneKljun$zm[i]/epOutJuneKljun$L[i])< -0.05) { #unstable
    epOutJuneKljun$blH[i]<-1500
  } 
  else if((epOutJuneKljun$zm[i]/epOutJuneKljun$L[i])>0.05){ #stable
    epOutJuneKljun$blH[i]<-((epOutJuneKljun$L[i]/3.8)*(-1+(1+(2.28*(epOutJuneKljun$ustar[i])/(epOutJuneKljun$L[i]*0.0000927)))^0.5))
  }
  else if(abs(epOutJuneKljun$zm[i]/epOutJuneKljun$L[i])<=0.05){ # near neutral
    epOutJuneKljun$blH[i]<- 0.3*epOutJuneKljun$ustar[i]/0.0000927
  }
}

epOutJuneKljunFilt<-filter(epOutJuneKljun, ustar>0.1)
epOutJuneKljunFilt<-filter(epOutJuneKljunFilt, L>-0.184)

FFP<-calc_footprint_FFP_climatology(zm=epOutJuneKljunFilt$zm,
                         z0=NaN,
                         umean=epOutJuneKljunFilt$u_rot,
                         h=epOutJuneKljunFilt$blH,
                         ol=epOutJuneKljunFilt$L,
                         sigmav=epOutJuneKljunFilt$sigma_v,
                         ustar=epOutJuneKljunFilt$ustar,
                         wind_dir=epOutJuneKljunFilt$wind_dir,
                         domain=c(-100,100,-100,100))

#Crosswind‐integrated footprint
plot(FFP$x.ci,FFP$f.ci, type="l")

#Two‐dimensional footprint with contour lines of R% (using the fields package)
image.plot(FFP$x_2d[1,], FFP$y_2d[,1], FFP$fclim_2d)
box()
for (i in 1:8) lines(FFP$xr[[i]], FFP$yr[[i]], type="l", col="red")

#Three‐dimensional footprint surface (using the plot3D package)
surf3D(FFP$x_2d, FFP$y_2d,FFP$fclim_2d)



summary(epOutJuneUF0.05$blH)

```
##Using Package FREddyPro


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

##qaqc fluxes
epOut$u.<-epOut$wind_speed

cleanFluxes(epOut, sdCor=TRUE, plot=TRUE)

ggplot(epOutFilt, aes(RDateTime, co2_flux))+
  geom_point()

plotFingerprint(epOutFilt$ch4_flux, epOutFilt$DOY, epOutFilt$time, xlab="hour", ylab="day")

plotMonthly(epOut)

```


## EddyPro Output QAQC


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

#It makes more sense to me to separate the four fluxes: H, LE, CO2, and CH4, then perform QAQC on them from there

epOutCO2<-select(epOut, co2_flux, qc_co2_flux, rand_err_co2_flux, co2_strg, co2_mole_fraction, co2_mixing_ratio, ustar, wind_dir, wind_speed, spikes_hf, amplitude_resolution_hf, drop_out_hf, absolute_limits_hf, skewness_kurtosis_hf, discontinuities_hf, timelag_hf, co2_spikes, chopper_LI7500, detector_LI7500, pll_LI7500, sync_LI7500, mean_value_RSSI_LI7500, RDateTime)

epOut5CO2<-select(epOut5, co2_flux, qc_co2_flux, rand_err_co2_flux, co2_strg, co2_mole_fraction, co2_mixing_ratio, ustar, wind_dir, spikes_hf, amplitude_resolution_hf, drop_out_hf, absolute_limits_hf, skewness_kurtosis_hf, discontinuities_hf, timelag_hf, co2_spikes, chopper_LI7500, detector_LI7500, pll_LI7500, sync_LI7500, mean_value_RSSI_LI7500, RDateTime)

ggplot(epOutCO2, aes(RDateTime, co2_flux))+
  geom_point(alpha=0.1)

epOutCO2F1<-filter(epOutCO2, qc_co2_flux<2)
epOut5CO2F1<-filter(epOut5CO2, qc_co2_flux<2)
epOut5CO2E<-filter(epOut5CO2F1, wind_dir<165)

ggplot(epOutCO2F1, aes(RDateTime, co2_flux))+
  geom_point(alpha=0.1)
ggplot(epOut5CO2E, aes(RDateTime, co2_flux))+
  geom_point(alpha=0.1)+
  ylim(-20, 20)
```


## Soft flag filtering
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#the spikes, amplitude resolution, drop outs, absolute limits, skewness/kurtosis, and discontinuities are all bitmaps with the format: 8u/v/w/ts/co2/h2o/ch4/none. That is, if co2 is hard flagged, it will show up as a "1" in the 6th digit from the left/4th digit from the right. These variables have been loaded as characters. Can use strsplit to parse them:

#example from http://rfunction.com/archives/1499
temp<-strsplit(epOutCO2F1$spikes_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_spikes<-as.data.frame(tMat)
colnames(df_spikes)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_spikes", "h2o_flag", "ch4_flag", "none_flag"))
df_spikes<-select(df_spikes, co2_flag_spikes)

temp<-strsplit(epOutCO2F1$amplitude_resolution_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_amp_res<-as.data.frame(tMat)
colnames(df_amp_res)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_amp_res", "h2o_flag", "ch4_flag", "none_flag"))
df_amp_res<-select(df_amp_res, co2_flag_amp_res)

temp<-strsplit(epOutCO2F1$drop_out_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_drop_outs<-as.data.frame(tMat)
colnames(df_drop_outs)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_drop_outs", "h2o_flag", "ch4_flag", "none_flag"))
df_drop_outs<-select(df_drop_outs, co2_flag_drop_outs)

temp<-strsplit(epOutCO2F1$absolute_limits_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_abs_lims<-as.data.frame(tMat)
colnames(df_abs_lims)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_abs_lims", "h2o_flag", "ch4_flag", "none_flag"))
df_abs_lims<-select(df_abs_lims, co2_flag_abs_lims)

temp<-strsplit(epOutCO2F1$skewness_kurtosis_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_skew_kur<-as.data.frame(tMat)
colnames(df_skew_kur)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_skew_kur", "h2o_flag", "ch4_flag", "none_flag"))
df_skew_kur<-select(df_skew_kur, co2_flag_skew_kur)

temp<-strsplit(epOutCO2F1$discontinuities_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_discont<-as.data.frame(tMat)
colnames(df_discont)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_discont", "h2o_flag", "ch4_flag", "none_flag"))
df_discont<-select(df_discont, co2_flag_discont)

df_spikes$RDateTime<-epOutCO2F1$RDateTime
df_amp_res$RDateTime<-epOutCO2F1$RDateTime
df_drop_outs$RDateTime<-epOutCO2F1$RDateTime
df_abs_lims$RDateTime<-epOutCO2F1$RDateTime
df_skew_kur$RDateTime<-epOutCO2F1$RDateTime
df_discont$RDateTime<-epOutCO2F1$RDateTime

summary(df_spikes) #376 hard flags, 12056 passes
summary(df_amp_res) #only one hard flag for CO2
summary(df_drop_outs) #only one hard flag for CO2
summary(df_abs_lims) #224 hard flags, 12188 passes
summary(df_skew_kur) #1744 hard flags, 10688 passes
summary(df_discont) #351 hard flags, 12081 passes
```

## Processing 5-min fluxes back into 30-min via block avearging
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#1. Sort into E and W fluxes


epOut5CO2E<-filter(epOut5CO2F1, wind_dir<195 | wind_dir>330)
epOut5CO2W<-filter(epOut5CO2F1, wind_dir>195 & wind_dir<330)

#2.Block average into 30 min fluxes
epOut5Co2Esort<-epOut5CO2E[order(epOut5CO2E$RDateTime),]
epOut5Co2Esort<-epOut5Co2Esort[-c(1:11),]

epOut5CO2E30<-epOut5Co2Esort%>%
  group_by(RDateTime=cut(RDateTime, breaks="30 min"))%>%
  summarize(meanFco2=mean(co2_flux))

tmprDaily<-epOut%>%
  group_by(RDateTime=cut(RDateTime, breaks="1 day"))%>%
  summarize(meanTmpr=mean(air_temperature-273.15))
tmprDaily$RDateTime <- as.POSIXct(tmprDaily$RDateTime,
                                  format="%Y-%m-%d",
                                  tz = "UTC")  # POSIXct


epOut5CO2E30$RDateTime <- as.POSIXct(epOut5CO2E30$RDateTime,
                                  format="%Y-%m-%d%H:%M:%S",
                                  tz = "UTC")  # POSIXct
ggplot(epOut5CO2E30, aes(RDateTime, meanFco2))+
  geom_point(alpha=0.2)+
  ylim(-20, 20)

epOut5vs30<-left_join(epOut5CO2E30, epOutCO2east, by="RDateTime")

ggplot(epOut5vs30, aes(co2_flux, meanFco2))+
  geom_point()

```

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#distribution of 30-min CO2 fluxes

ggplot(epOutSubFilt, aes(co2_flux))+
  geom_histogram(binwidth=0.5)+
  xlim(-25, 25)
#dist of 5-min fluxes
ggplot(epOut5CO2E, aes(co2_flux))+
  geom_histogram(binwidth=0.5)+
  xlim(-25, 25)
    
epOutCO2F2<-left_join(epOutCO2F1, df_skew_kur, by="RDateTime")

epOutCO2F3<-filter(epOutCO2F2, co2_flag_skew_kur=="0")

ggplot(epOutCO2F3, aes(RDateTime, co2_flux))+
  geom_point(alpha=0.1)+


str(df_spikes)


ggplot(epOutCO2F1, aes(ustar, co2_flux))+
  geom_point(alpha=0.1)+
  ylim(-50, 50)

epOutCO2F3$date<-epOutCO2F3$RDateTime


epOutCO2east<-filter(epOutCO2F1, wind_dir<195 | wind_dir>330)

ggplot(epOutCO2F3, aes(wind_dir, co2_flux))+
  geom_point(alpha=0.1)+
  ylim(-100, 100)

ggplot(epOutCO2east, aes(ustar, co2_flux))+
  geom_point(alpha=0.1)
#let's filter for ustar>0.5

epOutCO2eastFU<-filter(epOutCO2east, ustar<0.5)
ggplot(epOutCO2eastFU, aes(ustar, co2_flux))+
  geom_point(alpha=0.1)

ggplot(epOutCO2eastFU, aes(date, co2_flux))+
  geom_point(alpha=0.2)

epOutCO2eastFUhf<-filter(epOutCO2eastFU, abs(co2_flux)<50)

co2fluxDiurnalPlot<-timeVariation(epOutCO2eastFUhf, pollutant="co2_flux", type="month")
plot(co2fluxDiurnalPlot, subset="hour")

```

##Let's do that over, for CH4

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

#It makes more sense to me to separate the four fluxes: H, LE, CO2, and CH4, then perform QAQC on them from there

epOutCH4<-select(epOut, ch4_flux, qc_ch4_flux, rand_err_ch4_flux, ch4_strg, ch4_mole_fraction, ch4_mixing_ratio, ustar, wind_dir, u_rot, spikes_hf, amplitude_resolution_hf, drop_out_hf, absolute_limits_hf, skewness_kurtosis_hf, discontinuities_hf, timelag_hf, ch4_spikes, chopper_LI7500, detector_LI7500, pll_LI7500, sync_LI7500, mean_value_RSSI_LI7500, RDateTime, time)

ggplot(epOutCH4, aes(RDateTime, ch4_flux))+
  geom_point(alpha=0.1)

epOutCH4F1<-filter(epOutCH4, qc_ch4_flux<2)

ggplot(epOutCH4F1, aes(RDateTime, ch4_flux))+
  geom_point(alpha=0.1)

#hard filter for the two extreme outliers
epOutCH4F1<-(filter(epOutCH4F1, abs(ch4_flux)<600))

```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#the spikes, amplitude resolution, drop outs, absolute limits, skewness/kurtosis, and discontinuities are all bitmaps with the format: 8u/v/w/ts/co2/h2o/ch4/none. That is, if ch4 is hard flagged, it will show up as a "1" in the 8th digit from the left/2nd digit from the right. These variables have been loaded as characters. Can use strsplit to parse them:

#example from http://rfunction.com/archives/1499
temp<-strsplit(epOutCH4F1$spikes_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_spikes<-as.data.frame(tMat)
colnames(df_spikes)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_spikes", "h2o_flag", "ch4_flag_spikes", "none_flag"))
df_spikes<-select(df_spikes, ch4_flag_spikes)

temp<-strsplit(epOutCH4F1$amplitude_resolution_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_amp_res<-as.data.frame(tMat)
colnames(df_amp_res)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_amp_res", "h2o_flag", "ch4_flag_amp_res", "none_flag"))
df_amp_res<-select(df_amp_res, ch4_flag_amp_res)

temp<-strsplit(epOutCH4F1$drop_out_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_drop_outs<-as.data.frame(tMat)
colnames(df_drop_outs)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_drop_outs", "h2o_flag", "ch4_flag_drop_outs", "none_flag"))
df_drop_outs<-select(df_drop_outs, ch4_flag_drop_outs)

temp<-strsplit(epOutCH4F1$absolute_limits_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_abs_lims<-as.data.frame(tMat)
colnames(df_abs_lims)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_abs_lims", "h2o_flag", "ch4_flag_abs_lims", "none_flag"))
df_abs_lims<-select(df_abs_lims, ch4_flag_abs_lims)

temp<-strsplit(epOutCH4F1$skewness_kurtosis_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_skew_kur<-as.data.frame(tMat)
colnames(df_skew_kur)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_skew_kur", "h2o_flag", "ch4_flag_skew_kur", "none_flag"))
df_skew_kur<-select(df_skew_kur, ch4_flag_skew_kur)

temp<-strsplit(epOutCH4F1$discontinuities_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_discont<-as.data.frame(tMat)
colnames(df_discont)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_discont", "h2o_flag", "ch4_flag_discont", "none_flag"))
df_discont<-select(df_discont, ch4_flag_discont)

df_spikes$RDateTime<-epOutCH4F1$RDateTime
df_amp_res$RDateTime<-epOutCH4F1$RDateTime
df_drop_outs$RDateTime<-epOutCH4F1$RDateTime
df_abs_lims$RDateTime<-epOutCH4F1$RDateTime
df_skew_kur$RDateTime<-epOutCH4F1$RDateTime
df_discont$RDateTime<-epOutCH4F1$RDateTime

summary(df_spikes) #0 hard flags out of 8060
summary(df_amp_res) #628 hard flags for ch4, 7432 passes
summary(df_drop_outs) #0 hard flags for ch4
summary(df_abs_lims) #5359 hard flags, 2701 passes  -- set to 0.17 and 100
#seems suspect. I inspected the raw data for 4/14/2017 from noon-16:00. This time period 
#was assigned three hard flags for absolute limits, but has a min and max of 1.9 and 4.5 ppm CH4. They also don't have discontinuities. 
summary(df_skew_kur) #6460 hard flags, 1600 passes  -- set to 40
summary(df_discont) #5129 hard flags, 2931 passes



```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
epOutCH4F2<-left_join(epOutCH4F1, df_abs_lims, by="RDateTime")
epOutCH4F2$ch4_fluxmgm2h<-epOutCH4F2$ch4_flux*60*60*16/1000

ggplot(epOutCH4F2, aes(RDateTime, ch4_flag_abs_lims))+
  geom_point(alpha=0.1)

ggplot(epOutCH4F3, aes(RDateTime, ch4_flux))+
  geom_point(alpha=0.1)

str(df_spikes)


ggplot(epOutCH4F2, aes(ustar, ch4_flux))+
  geom_point(alpha=0.1)

epOutCH4F2$date<-epOutCH4F2$RDateTime

epOutCH4east<-filter(epOutCH4F2, wind_dir<195 | wind_dir>330)

ggplot(epOutCH4F2, aes(wind_dir, ch4_flux))+
  geom_point(alpha=0.1)

ggplot(epOutCH4east, aes(ustar, ch4_flux))+
  geom_point(alpha=0.1)
#doesn't appear to be a ustar issue with CH4

# epOutCH4eastFU<-filter(epOutCH4east, ustar<0.5)
# ggplot(epOutCH4eastFU, aes(ustar, ch4_flux))+
#   geom_point(alpha=0.1)

#Feb, March, April
epOutCH4eastSpr<-filter(epOutCH4east, RDateTime>"2017-02-01 00:00:00 UTC" & RDateTime<"2017-05-01 00:00:00 UTC" & ch4_fluxmgm2h>0)
#May, June, July
epOutCH4eastJuly<-filter(epOutCH4east, RDateTime>"2017-07-01 00:00:00 UTC" & RDateTime<"2017-08-01 00:00:00 UTC" & ch4_fluxmgm2h >0)
#Aug, Sept, Oct
epOutCH4eastFal<-filter(epOutCH4east, RDateTime>"2017-08-01 00:00:00 UTC" & RDateTime<"2017-11-01 00:00:00 UTC" & ch4_fluxmgm2h >0)

epOutCH4eastPer<-filter(epOutCH4east, RDateTime>"2017-05-01 00:00:00 UTC" & RDateTime<"2017-09-30 00:00:00 UTC" & ch4_fluxmgm2h >0)
epOutCH4eastPer$time<-as.factor(epOutCH4eastPer$time)
epOutCH4eastPer$time<-as.character(epOutCH4eastPer$time)
epOutCH4eastPer$time<-as.numeric(epOutCH4eastPer$time)

CH4fluxDiurnalPlotSpr<-timeVariation(epOutCH4eastSpr, pollutant="ch4_fluxmgm2h", type="month", statistic="mean", name.pol=expression(CH[4]~Flux~(mg~m^{-2}~hr^{-1})))
CH4fluxDiurnalPlotJuly<-timeVariation(epOutCH4eastJuly, pollutant="ch4_fluxmgm2h", type="month", name.pol=expression(CH[4]~Flux~(mg~m^{-2}~hr^{-1})))
CH4fluxDiurnalPlotFal<-timeVariation(epOutCH4eastFal, pollutant="ch4_fluxmgm2h", type="month", name.pol=expression(CH[4]~Flux~(mg~m^{-2}~hr^{-1})))
plot(CH4fluxDiurnalPlotSpr, subset="hour")
plot(CH4fluxDiurnalPlotJuly, subset="hour")
plot(CH4fluxDiurnalPlotFal, subset="hour")

epOut$date<-epOut$RDateTime

epOutSum<-filter(epOut, RDateTime>"2017-06-01 00:00:00 UTC" & RDateTime<"2017-09-01 00:00:00 UTC")
#pressure may drive dirunal patterns in CH4 ebullition
pressureDiurnalPlot<-timeVariation(epOutSum, pollutant="air_p_mean",
                                   #type="month", 
                                   normalise=TRUE)
plot(pressureDiurnalPlot, subset="hour")

epOutVwsSum<-filter(epOutVws, RDateTime>"2017-05-01 00:00:00 UTC" & RDateTime<"2017-09-30 00:00:00 UTC")
#pressure may drive dirunal patterns in CH4 ebullition
HSPDiurnalPlot<-timeVariation(epOutVwsSum, pollutant="hsPressure",
                                   type="month", 
                                   normalise=TRUE)
plot(HSPDiurnalPlot, subset="hour")

CH4_HSPcomp<-left_join(epOutCH4eastPer, epOutVwsSum, by="RDateTime")
CH4_HSPcomp$date<-CH4_HSPcomp$RDateTime

CH4_compPlot<-timeVariation(CH4_HSPcomp, pollutant="ch4_fluxmgm2h",
                                   type="month", 
                                   normalise=TRUE,
                            cols="blue")
plot(CH4_compPlot, subset="hour")

CH4_HSPcompPlot<-timeVariation(CH4_HSPcomp, pollutant="hsPressure",
                                   type="month", 
                                   normalise=TRUE)
plot(CH4_HSPcompPlot, subset="hour")


epOutCH4eastPer$Time<-epOutCH4eastPer$RDateTime%>%
    unclass(RDateTime)
    
epOutCH4eastPer$Time<-as.numeric(epOutCH4eastPer$Time)
ggplot(epOutCH4eastPer, aes(time))+
  geom_bar(stat="count")+
  coord_flip()
```


##Daily CH4 from the water
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

ch4eastDaily<-epOutCH4east%>%
  group_by(RDateTime=cut(RDateTime, breaks="1 day"))%>%
  summarize(meanFch4=mean(ch4_flux))

tmprDaily<-epOut%>%
  group_by(RDateTime=cut(RDateTime, breaks="1 day"))%>%
  summarize(meanTmpr=mean(air_temperature-273.15))
tmprDaily$RDateTime <- as.POSIXct(tmprDaily$RDateTime,
                                  format="%Y-%m-%d",
                                  tz = "UTC")  # POSIXct


ch4eastDaily$RDateTime <- as.POSIXct(ch4eastDaily$RDateTime,
                                  format="%Y-%m-%d",
                                  tz = "UTC")  # POSIXct
ggplot(ch4eastDaily, aes(RDateTime, meanFch4*57.6*24))+
  geom_point()

ch4eastDaily<-left_join(ch4eastDaily, epOutHSPDaily, by="RDateTime")
ch4eastDaily<-left_join(ch4eastDaily, epOutAPDaily, by="RDateTime")
ch4eastDaily<-left_join(ch4eastDaily, tmprDaily, by="RDateTime")

ch4eastDaily$HSPdiff<-c(NA, diff(ch4eastDaily$meanHSP, lag=1))
ch4eastDaily$APdiff<-c(NA, diff(ch4eastDaily$meanAP, lag=1))

ggplot(ch4eastDaily, aes(meanTmpr, log(meanFch4*57.6*24)))+
  geom_point(alpha=0.5)+
  xlab("Mean Daily T")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~hr^{-1})))

ggplot(ch4eastDaily, aes(cut_number(meanTmpr, 10, boundary=-5), log(meanFch4*57.6*24)))+
  geom_boxplot()+
  xlab("Mean Daily T")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~hr^{-1})))



binnedDF<-data.frame(binnedCH4, binnedT)
ggplot(binnedDF, aes(binnedT, binnedCH4*57.6*24))+
  geom_point(alpha=0.5)+
  xlab("Mean Daily T")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~hr^{-1})))


ggplot(ch4eastDaily, aes(HSPdiff, meanFch4*57.6*24))+
  geom_point(alpha=0.5)+
  xlab("Delta Hydrostatic Pressure (Pa)")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~hr^{-1})))

ggplot(ch4eastDaily, aes(APdiff, meanFch4*57.6*24))+
  geom_point(alpha=0.5)+
  xlab("Delta Air Pressure (Pa)")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~hr^{-1})))

ggplot(ch4eastDaily, aes(meanHSP/1000, meanFch4*57.6*24))+
  geom_point(alpha=0.5, size = 3)+
  xlab("Daily Mean Total Hydrostatic Pressure (kPa)")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~d^{-1})))+
  theme_classic()+
  theme(axis.text = element_text(size=14), axis.title=element_text(size=15))

ggplot(ch4eastDaily, aes(meanAP/1000, meanFch4*57.6*24))+
  geom_point(alpha=0.5)+
  xlab("Daily Mean Air Pressure (kPa)")+
    ylab(expression(Daily~Mean~CH[4]~Flux~(mg~m^{-2}~hr^{-1})))

```

#wind roses
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

epOutSub$date<-epOutSub$RDateTime
windRose(epOutSub, ws="u_rot", wd="wind_dir")

windRose(epOutCH4eastSpr, ws="u_rot", wd="wind_dir")
windRose(epOutCH4F2, ws="u_rot", wd="wind_dir")

epOut$date<-epOut$RDateTime
epOutDay<-filter(epOutSub, daytime==1)
epOutNight<-filter(epOutSub, daytime==0)

windRose(epOutDay, ws="u_rot", wd="wind_dir", ws.int=2)
windRose(epOutNight, ws="u_rot", wd="wind_dir", ws.int=2)

```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
epOutCO2F2<-left_join(epOutCO2F1, df_skew_kur, by="RDateTime")

epOutCO2F3<-filter(epOutCO2F2, co2_flag_skew_kur=="0")

ggplot(epOutCO2F3, aes(RDateTime, co2_flux))+
  geom_point(alpha=0.1)

str(df_spikes)


ggplot(epOutCO2F3, aes(ustar, co2_flux))+
  geom_point(alpha=0.1)+
  ylim(-50, 50)

epOutCO2F3$date<-epOutCO2F3$RDateTime

epOutCO2east<-filter(epOutCO2F3, wind_dir<195 | wind_dir>330)

ggplot(epOutCO2F3, aes(wind_dir, co2_flux))+
  geom_point(alpha=0.1)+
  ylim(-100, 100)

ggplot(epOutCO2east, aes(ustar, co2_flux))+
  geom_point(alpha=0.1)
#let's filter for ustar>0.5

epOutCO2eastFU<-filter(epOutCO2east, ustar<0.5)
ggplot(epOutCO2eastFU, aes(ustar, co2_flux))+
  geom_point(alpha=0.1)

ggplot(epOutCO2eastFU, aes(date, co2_flux))+
  geom_point(alpha=0.2)

epOutCO2eastFUhf<-filter(epOutCO2eastFU, abs(co2_flux)<50)

co2fluxDiurnalPlot<-timeVariation(epOutCO2eastFUhf, pollutant="co2_flux", type="month")
plot(co2fluxDiurnalPlot, subset="hour")

```

##And for LE

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

#It makes more sense to me to separate the four fluxes: H, LE, CO2, and CH4, then perform QAQC on them from there

epOutLE<-select(epOut, LE, qc_LE, rand_err_LE, LE_strg, h2o_mole_fraction, h2o_mixing_ratio, ustar, wind_dir, spikes_hf, amplitude_resolution_hf, drop_out_hf, absolute_limits_hf, skewness_kurtosis_hf, discontinuities_hf, timelag_hf, chopper_LI7500, detector_LI7500, pll_LI7500, sync_LI7500, mean_value_RSSI_LI7500, RDateTime)

ggplot(epOutLE, aes(RDateTime, LE))+
  geom_point(alpha=0.1)

epOutLEF1<-filter(epOutLE, qc_LE<2)

ggplot(epOutLEF1, aes(RDateTime, LE))+
  geom_point(alpha=0.1)

#hard filter for the two extreme outliers
epOutLEF1<-(filter(epOutLEF1, abs(LE)<1500))

```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#the spikes, amplitude resolution, drop outs, absolute limits, skewness/kurtosis, and discontinuities are all bitmaps with the format: 8u/v/w/ts/co2/h2o/ch4/none. That is, if ch4 is hard flagged, it will show up as a "1" in the 8th digit from the left/2nd digit from the right. These variables have been loaded as characters. Can use strsplit to parse them:

#example from http://rfunction.com/archives/1499
temp<-strsplit(epOutLEF1$spikes_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_spikes<-as.data.frame(tMat)
colnames(df_spikes)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_spikes", "h2o_flag_spikes", "ch4_flag_spikes", "none_flag"))
df_spikes<-select(df_spikes, h2o_flag_spikes)

temp<-strsplit(epOutLEF1$amplitude_resolution_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_amp_res<-as.data.frame(tMat)
colnames(df_amp_res)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_amp_res", "h2o_flag_amp_res", "ch4_flag_amp_res", "none_flag"))
df_amp_res<-select(df_amp_res, h2o_flag_amp_res)

temp<-strsplit(epOutLEF1$drop_out_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_drop_outs<-as.data.frame(tMat)
colnames(df_drop_outs)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_drop_outs", "h2o_flag_drop_outs", "ch4_flag_drop_outs", "none_flag"))
df_drop_outs<-select(df_drop_outs, h2o_flag_drop_outs)

temp<-strsplit(epOutLEF1$absolute_limits_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_abs_lims<-as.data.frame(tMat)
colnames(df_abs_lims)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_abs_lims", "h2o_flag_abs_lims", "ch4_flag_abs_lims", "none_flag"))
df_abs_lims<-select(df_abs_lims, h2o_flag_abs_lims)

temp<-strsplit(epOutLEF1$skewness_kurtosis_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_skew_kur<-as.data.frame(tMat)
colnames(df_skew_kur)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_skew_kur", "h2o_flag_skew_kur", "ch4_flag_skew_kur", "none_flag"))
df_skew_kur<-select(df_skew_kur, h2o_flag_skew_kur)

temp<-strsplit(epOutLEF1$discontinuities_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_discont<-as.data.frame(tMat)
colnames(df_discont)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag", "co2_flag_discont", "h2o_flag_discont", "ch4_flag_discont", "none_flag"))
df_discont<-select(df_discont, h2o_flag_discont)

df_spikes$RDateTime<-epOutLEF1$RDateTime
df_amp_res$RDateTime<-epOutLEF1$RDateTime
df_drop_outs$RDateTime<-epOutLEF1$RDateTime
df_abs_lims$RDateTime<-epOutLEF1$RDateTime
df_skew_kur$RDateTime<-epOutLEF1$RDateTime
df_discont$RDateTime<-epOutLEF1$RDateTime

summary(df_spikes) #22 hard flags, 13978 passes
summary(df_amp_res) #0 hard flags for LE out of 14000
summary(df_drop_outs) #0 hard flags
summary(df_abs_lims) #14000 hard flags -- all of them! max is set to 40 mmol/mol -- too low?
#seems suspect. I inspected the raw data for 4/14/2017 from noon-16:00. This time period 
#was assigned three hard flags for absolute limits, but has a min and max of 1.9 and 4.5 ppm CH4. They also don't have discontinuities. 
summary(df_skew_kur) #944 hard flags
summary(df_discont) #417 hard flags


```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
epOutLEF2<-left_join(epOutLEF1, df_abs_lims, by="RDateTime")

ggplot(epOutLEF2, aes(RDateTime, h2o_flag_abs_lims))+
  geom_point(alpha=0.1)

ggplot(epOutLEF2, aes(ustar, LE))+
  geom_point(alpha=0.1)

epOutLEF2$date<-epOutLEF2$RDateTime

epOutLEeast<-filter(epOutLEF2, wind_dir<195 | wind_dir>330)

ggplot(epOutLEF2, aes(wind_dir, LE))+
  geom_point(alpha=0.1)

ggplot(epOutLEeast, aes(ustar, LE))+
  geom_point(alpha=0.1)
#doesn't appear to be a ustar issue with LE


LEfluxDiurnalPlot<-timeVariation(epOutLEeast, pollutant="LE", type="month", statistic="median", conf.int=0.75)
plot(LEfluxDiurnalPlot, subset="hour")

```
##And for H

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

#It makes more sense to me to separate the four fluxes: H, LE, CO2, and CH4, then perform QAQC on them from there

epOutH<-select(epOut, H, qc_H, rand_err_H, H_strg, h2o_mole_fraction, h2o_mixing_ratio, ustar, wind_dir, wind_speed, spikes_hf, amplitude_resolution_hf, drop_out_hf, absolute_limits_hf, skewness_kurtosis_hf, discontinuities_hf, timelag_hf, chopper_LI7500, detector_LI7500, pll_LI7500, sync_LI7500, mean_value_RSSI_LI7500, RDateTime)

ggplot(epOutH, aes(RDateTime, H))+
  geom_point(alpha=0.1)

epOutHF1<-filter(epOutH, qc_H<2)

ggplot(epOutHF1, aes(RDateTime, H))+
  geom_point(alpha=0.1)

#hard filter for the few extreme outliers
epOutHF1<-(filter(epOutHF1, abs(H)<1000))

```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#the spikes, amplitude resolution, drop outs, absolute limits, skewness/kurtosis, and discontinuities are all bitmaps with the format: 8u/v/w/ts/co2/h2o/ch4/none. That is, if ch4 is hard flagged, it will show up as a "1" in the 8th digit from the left/2nd digit from the right. These variables have been loaded as characters. Can use strsplit to parse them:

#example from http://rfunction.com/archives/1499
temp<-strsplit(epOutHF1$spikes_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_spikes<-as.data.frame(tMat)
colnames(df_spikes)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag_spikes", "co2_flag_spikes", "h2o_flag_spikes", "ch4_flag_spikes", "none_flag"))
df_spikes<-select(df_spikes, ts_flag_spikes)

temp<-strsplit(epOutHF1$amplitude_resolution_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_amp_res<-as.data.frame(tMat)
colnames(df_amp_res)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag_amp_res", "co2_flag_amp_res", "h2o_flag_amp_res", "ch4_flag_amp_res", "none_flag"))
df_amp_res<-select(df_amp_res, ts_flag_amp_res)

temp<-strsplit(epOutHF1$drop_out_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_drop_outs<-as.data.frame(tMat)
colnames(df_drop_outs)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag_drop_outs", "co2_flag_drop_outs", "h2o_flag_drop_outs", "ch4_flag_drop_outs", "none_flag"))
df_drop_outs<-select(df_drop_outs, ts_flag_drop_outs)

temp<-strsplit(epOutHF1$absolute_limits_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_abs_lims<-as.data.frame(tMat)
colnames(df_abs_lims)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag_abs_lims", "co2_flag_abs_lims", "h2o_flag_abs_lims", "ch4_flag_abs_lims", "none_flag"))
df_abs_lims<-select(df_abs_lims, ts_flag_abs_lims)

temp<-strsplit(epOutHF1$skewness_kurtosis_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_skew_kur<-as.data.frame(tMat)
colnames(df_skew_kur)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag_skew_kur", "co2_flag_skew_kur", "h2o_flag_skew_kur", "ch4_flag_skew_kur", "none_flag"))
df_skew_kur<-select(df_skew_kur, ts_flag_skew_kur)

temp<-strsplit(epOutHF1$discontinuities_hf, "")
tMat<-matrix(unlist(temp), ncol=9, byrow=TRUE)
df_discont<-as.data.frame(tMat)
colnames(df_discont)=(c("eight", "u_flag", "v_flag", "w_flag", "ts_flag_discont", "co2_flag_discont", "h2o_flag_discont", "ch4_flag_discont", "none_flag"))
df_discont<-select(df_discont, ts_flag_discont)

df_spikes$RDateTime<-epOutHF1$RDateTime
df_amp_res$RDateTime<-epOutHF1$RDateTime
df_drop_outs$RDateTime<-epOutHF1$RDateTime
df_abs_lims$RDateTime<-epOutHF1$RDateTime
df_skew_kur$RDateTime<-epOutHF1$RDateTime
df_discont$RDateTime<-epOutHF1$RDateTime

summary(df_spikes) #0 hard flags, 14377 passes
summary(df_amp_res) #0 hard flags 
summary(df_drop_outs) #0 hard flags
summary(df_abs_lims) #1 hard flag 
summary(df_skew_kur) #878 hard flags, 13499 passes
summary(df_discont) #10 hard flags


```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
epOutHF2<-left_join(epOutHF1, df_skew_kur, by="RDateTime")

ggplot(epOutHF2, aes(RDateTime, ts_flag_skew_kur))+
  geom_point(alpha=0.1)

ggplot(epOutHF2, aes(ustar, H))+
  geom_point(alpha=0.1)

epOutHF2$date<-epOutHF2$RDateTime

epOutHeast<-filter(epOutHF2, wind_dir<195 | wind_dir>330)

ggplot(epOutHF2, aes(wind_dir, H))+
  geom_point(alpha=0.1)

ggplot(epOutHeast, aes(ustar, H))+
  geom_point(alpha=0.1)
#lots of scatter after 0.45


HfluxDiurnalPlot<-timeVariation(epOutHeast, pollutant="H", type="month")
plot(HfluxDiurnalPlot, subset="hour")

```
```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}

epOutH_LEeast<-full_join(epOutHeast, epOutLEeast, by="date")

HLEfluxDiurnalPlot<-timeVariation(epOutH_LEeast, pollutant=c("H", "LE"), type="month", statistic="mean", ci=FALSE)
plot(HLEfluxDiurnalPlot, subset="hour")



```




```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
library(openair)
epOutCO2F1$date<-epOutCO2F1$RDateTime
windRose(epOutCO2F1, ws="wind_speed", wd="wind_dir")

```

